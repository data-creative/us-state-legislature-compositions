<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>US State Legislature Compositions</title>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
    <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"-->
  </head>
  <body>
    <h1 style="display:inline-block;">
      US State Legislatures
      by <span id="dimension-display">Size</span>
      in <span id="year-display">2009</span>
    </h1>

    <div id="dimension-input-group" style="margin: 0 2em;">
      <label for="dimension-selector">Select a Dimension:</label>
      <select id="dimension-selector" title="Select a composition dimension.">
        <option value="size">Legislature Size</option>
        <option value="pct-male">Legislature Percent Male</option>
        <option value="pct-female">Legislature Percent Female</option>
        <option value="pct-dem">Legislature Percent Democrat</option>
        <option value="pct-gop">Legislature Percent Republican</option>
      </select>
    </div>

    <div id="year-input-group" style="margin: 0 2em;">
      <label for="year-slider">Select a Year:</label>
      <!--span>2009</span-->
      <input type="range" id="year-slider" title="Select a year." min=2009 max=2016 value=2009 step=1 defaultValue=2009>
      <!--span>2016</span-->
    </div>

    <div id="player-controls" style="margin: 0 2em;">
      <span>Year Player Controls:</span>
      <button type="button" id="year-play">
        <i class="fa fa-play" aria-hidden="true"></i>
      </button>
      <button type="button" id="year-pause">
        <i class="fa fa-pause" aria-hidden="true"></i>
      </button>
      <button type="button" id="year-restart">
        <i class="fa fa-fast-backward" aria-hidden="true"></i>
      </button>
    </div>

    <div id="map-container" style="height:40em; border:1px solid #000; margin:2em;"></div>

    <div id="map-footnotes" style="margin:2em;">
      <p id="partisanship-footnote"></p>
    </div>

    <div id="map-footer">
      <p>
        <a href="http://data-creative.github.io/us-state-legislature-compositions/">view</a> |
        <a href="https://github.com/data-creative/us-state-legislature-compositions">source</a> |
        <a href="https://github.com/dwillis/state_legislatures">data</a>
      </p>
    </div>

    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
    <script src='data/mapbox/us-states.js'></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src='https://d3js.org/colorbrewer.v1.min.js'></script>
    <script src="https://use.fontawesome.com/4fbdaa660e.js"></script>
    <script type="text/javascript">

        //
        // SELECTORS
        //

        // YEAR

        var yearDisplay = document.getElementById("year-display");
        var yearSelector = document.getElementById('year-slider');
        yearSelector.addEventListener("change", selectYear, false);

        function selectYear(){
            displayYear();
            updateMap();
        };

        function displayYear(){
            var selectedYear = yearSelector.value;
            console.log("YEAR", selectedYear);
            yearDisplay.innerHTML = selectedYear;
        };

        displayYear();

        // DIMENSION

        var dimensionDisplay = document.getElementById("dimension-display");
        var partisanshipFootnote = document.getElementById("partisanship-footnote");
        var dimensionSelector = document.getElementById('dimension-selector');
        dimensionSelector.addEventListener("change", selectDimension, false);

        function selectDimension(){
          displayDimension();
          displayPartisanshipFootnote();
          updateMap();
        };

        function displayDimension(){
          var selectedDimensionTitle = dimensionSelector[dimensionSelector.selectedIndex].textContent.trim();
          console.log("DIMENSION", selectedDimensionTitle)
          dimensionDisplay.innerHTML = selectedDimensionTitle;
        };

        function displayPartisanshipFootnote() {
          var selectedDimensionValue = dimensionSelector.value;
          if (selectedDimensionValue.includes("dem") || selectedDimensionValue.includes("gop")) {
            partisanshipFootnote.innerHTML = "NOTE: Nebraska's legislature is <a href='https://en.wikipedia.org/wiki/Nebraska_Legislature#Selection.2C_composition_and_operation' target='wikipedia'>technically nonpartisan</a>.";
          } else {
            partisanshipFootnote.innerHTML = "";
          };
        };

        displayDimension();

        //
        // COLORS
        //

        var colorScale = d3.scale.linear();

        function setColorPalette(){
            var selectedDimensionValue = dimensionSelector.value;
            var palette;
            switch(selectedDimensionValue){
                case "size":
                    palette = colorbrewer.Greys[9]
                    break;
                case "pct-dem":
                    palette = colorbrewer.Blues[9]
                    break;
                case "pct-gop":
                    palette = colorbrewer.Reds[9]
                    break;
                case "pct-male":
                    palette = colorbrewer.GnBu[9]
                    break;
                case "pct-female":
                    palette = colorbrewer.RdPu[9]
                    break;
                //default:
                //   palette = colorbrewer.YlGn[9]
            };
            colorScale.range([ palette[2], palette[5], palette[8] ]);
        };

        function calibrateColorScale(values){
            var quantiles = [ d3.min(values), d3.mean(values), d3.max(values) ]
            console.log("CALIBRATE COLORS AROUND", quantiles)
            colorScale.domain(quantiles);
        };

        //
        // MAP
        //

        var featureCollection = statesData; // see: us-states.js ... includes all states plus DC and PR
        L.mapbox.accessToken = 'pk.eyJ1IjoiczJ0MiIsImEiOiJQVFE0UW1JIn0.0MfEvAJVxFx7BLGoL0USXA';
        function logMapClick(cc){ console.log("MAP CLICKED ON GEOLOCATION: [" + cc.latlng.lat + ", " + cc.latlng.lng + "]"); };
        function logMapView(){ console.log("MAP VIEW: [" + map.getCenter().lat + ", " + map.getCenter().lng + "], " + map.getZoom()); };

        var map;
        var zz;
        function updateMap(){
            console.log("UPDATE MAP");
            var selectedYear = yearSelector.value;
            var selectedDimensionValue = dimensionSelector.value;
            var selectedDimensionTitle = dimensionSelector[dimensionSelector.selectedIndex].textContent.trim();

            if (typeof(map) != "undefined") { map.remove(); };
            map = L.mapbox.map('map-container', 'mapbox.streets', {scrollWheelZoom:false})
                .setView([40.111688665595956, -97.3388671875], 4)
                .on("click", logMapClick)
                .on("dragend", logMapView)
                .on("zoomend", logMapView);

            setColorPalette();

            var requestUrl = compileRequestUrl();
            d3.json(requestUrl, function(err, response){
                console.log("RESPONSE", response["year"], response["states"].length)
                zz = response["states"]; // for debugging in the console

                calibrateColorScale(lookupAllValues(response["states"]));

                featureCollection.features.forEach(function(feature){
                    var stateName = feature.properties.name;
                    var compositionValue = lookupValue(response["states"], stateName);
                    if (compositionValue) {
                        var popupContent = "<strong>State</strong>: " + stateName
                            + "<br/>" + "<strong>Year</strong>: " + selectedYear
                            + "<br/>" + "<strong>" + selectedDimensionTitle + "</strong>: " + compositionValue + compositionValueSuffix()

                        var stateLayer = L.geoJson(feature, {
                              style: {
                                  fillColor: colorScale(compositionValue),
                                  color: "#fff",
                                  weight: 1.5,
                                  opacity: .85,
                                  fillOpacity: .75,
                                  className: 'geojson state ' + stateName
                              }
                        });
                        stateLayer.bindPopup(popupContent);
                        map.addLayer(stateLayer);
                    };
                });
            });
        };

        var urlBase = "https://raw.githubusercontent.com/data-creative/state_legislatures/master/data/";
        function compileRequestUrl(){
            var selectedYear = yearSelector.value;
            var selectedDimensionValue = dimensionSelector.value;
            var url;
            switch(selectedDimensionValue){
                case "size":
                case "pct-dem":
                case "pct-gop":
                    url = urlBase + "party_composition/json/" + selectedYear + ".json"
                    break;
                case "pct-male":
                case "pct-female":
                    url = urlBase + "gender_composition/json/" + selectedYear + ".json"
                    break;
            };
            return url;
        };

        function lookupAllValues(statesArray){
            var valuesArray;
            var selectedDimensionValue = dimensionSelector.value;
            switch(selectedDimensionValue){
                case "size":
                    valuesArray = statesArray.map(function(stateObj){ return stateObj["legislature_seats"] });
                    break;
                case "pct-dem":
                    valuesArray = statesArray.map(function(stateObj){ return pctDem(stateObj); });
                    break;
                case "pct-gop":
                    valuesArray = statesArray.map(function(stateObj){ return pctRep(stateObj); });
                    break;
                case "pct-male":
                    valuesArray = statesArray.map(function(stateObj){ return pctMale(stateObj); });
                    break;
                case "pct-female":
                    valuesArray = statesArray.map(function(stateObj){ return pctFemale(stateObj); });
                    break;
                default:
                    valuesArray = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9] // todo: get rid of this default value
            };
            return valuesArray;
        };

        function lookupValue(statesArray, stateName){
            var value;
            var selectedDimensionValue = dimensionSelector.value;
            var stateObj = statesArray.find(function(stateObj){ return stateObj["name"] == stateName; });
            if (stateObj) {
                switch(selectedDimensionValue){
                    case "size":
                        value = stateObj["legislature_seats"];
                        break;
                    case "pct-dem":
                        value = pctDem(stateObj);
                        break;
                    case "pct-gop":
                        value = pctRep(stateObj);
                        break;
                    case "pct-male":
                        value = pctMale(stateObj);
                        break;
                    case "pct-female":
                        value = pctFemale(stateObj);
                        break;
                    default:
                        value = 0.7
                };
            };
            return value;
        };

        function pctFemale(stateObj){
            return +(stateObj["total_women"] / stateObj["total_seats"] * 100).toFixed(2)
        };

        function pctMale(stateObj){
            return +((stateObj["total_seats"] - stateObj["total_women"]) / stateObj["total_seats"] * 100).toFixed(2)
        };

        function pctDem(stateObj){
            var demSeats = d3.sum(stateObj["legislature_chambers"].map(function(chamber){  return chamber["composition"]["dem"] }));
            return +(demSeats / stateObj["legislature_seats"] * 100).toFixed(2);
        };

        function pctRep(stateObj){
            var repSeats = d3.sum(stateObj["legislature_chambers"].map(function(chamber){  return chamber["composition"]["rep"] }));
            return +(repSeats / stateObj["legislature_seats"] * 100).toFixed(2)
        };

        function compositionValueSuffix(){
            var selectedDimensionValue = dimensionSelector.value;
            if (selectedDimensionValue.includes("pct")) {
              return "%"
            } else {
              return " seats"
            };
        };

        updateMap();

        //
        // CONTROLS
        //

        // PLAY

        var playButton = document.getElementById("year-play");
        playButton.addEventListener("click", playYears, false);

        var playIntervalId;

        function playYears(){
            console.log("PLAY FROM", yearSelector.value);
            playIntervalId = setInterval(function(){
                if (yearSelector.value == yearSelector.max) {
                    console.log("NOT PLAYING")
                    pauseYears();
                } else {
                    yearSelector.stepUp();
                    displayYear();
                    updateMap();
                };
            }, 2500);
        };

        // PAUSE

        var pauseButton = document.getElementById("year-pause");
        pauseButton.addEventListener("click", pauseYears, false);

        function pauseYears(){
            console.log("PAUSE", yearSelector.value)
            clearInterval(playIntervalId);
            playIntervalId = null;
        };

        // START OVER

        var restartButton = document.getElementById("year-restart");
        restartButton.addEventListener("click", restartYears, false);

        function restartYears(){
            console.log("RESTART", yearSelector.value, "TO", yearSelector.defaultValue);
            pauseYears();
            yearSelector.value = yearSelector.defaultValue;
            displayYear();
            playYears();
        };

    </script>
  </body>
</html>
